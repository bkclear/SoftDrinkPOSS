<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoftDrinks POS Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; background: #f2f2f2; color: #333; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 2rem; }
    .card {
      background: #009688; color: white; border-radius: 12px; padding: 1.2rem;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center;
    }
    .card h3 { margin: 0.2rem 0; font-size: 1.5rem; }
    .card p { margin: 0; font-size: 0.9rem; opacity: 0.9; }
    input, select, button {
      width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px;
      border: 1px solid #ccc; box-sizing: border-box;
    }
    button { background: #009688; color: white; font-weight: bold; border: none; cursor: pointer; transition: background 0.3s ease; }
    button:hover { background: #00796b; }
    .section { background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .receipt { display:none; background:#fff; padding:1.5rem; border:1px solid #eee; border-radius:8px; margin-top:1.5rem; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
    .receipt p { margin: 5px 0; line-height: 1.4; }
    .receipt-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px dashed #eee; }
    .receipt-total { font-weight: bold; margin-top: 10px; border-top: 2px solid #333; padding-top: 10px; }
    .cart-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px dashed #eee;
    }
    .cart-item button { width: auto; padding: 5px 10px; margin: 0 0 0 10px; background: #f44336; }
    .cart-item button:hover { background: #d32f2f; }
    .total-due { font-size: 1.4rem; font-weight: bold; text-align: right; margin-top: 15px; }
    .button-group { display: flex; gap: 10px; margin-top: 10px; }
    .button-group button { flex: 1; }
    .clear-cart-btn { background: #f44336; }
    .clear-cart-btn:hover { background: #d32f2f; }
    #add-to-cart-btn { background: #4CAF50; }
    #add-to-cart-btn:hover { background: #45a049; }
    #complete-sale-btn { background: #2196F3; }
    #complete-sale-btn:hover { background: #1976D2; }
    .store-name { text-align: center; font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; color: #009688; }

    /* Print-specific styles (for the new print window) */
    @media print {
      body {
        margin: 0;
        padding: 0;
        background: none;
        color: #000; /* Ensure black text for printing */
      }
      .receipt-to-print {
        width: 100%;
        box-sizing: border-box;
        padding: 1.5rem;
        border: none; /* Remove border for cleaner print */
        box-shadow: none; /* Remove shadow for cleaner print */
      }
      .receipt-to-print .store-name {
        margin-top: 0;
      }
      /* Hide elements not needed in print, if the whole page were printed */
      .grid, .section:not(.receipt), .button-group, #add-to-cart-btn,
      #sell_product, #sell_unit, #sell_price, #sell_qty, hr {
        display: none !important;
      }
      /* Ensure receipt is visible if printing the whole page, though our new function handles this */
      .receipt {
        display: block !important;
      }
      button { /* Hide print button itself in the print output */
        display: none !important;
      }
    }
  </style>
</head>
<body>

  <div class="store-name">LLAVORE VARIETY STORE</div>

  <h2>ðŸ“Š Dashboard</h2>
  <div class="grid">
    <div class="card">
      <h3 id="totalSales">â‚±0</h3>
      <p>Sales Today</p>
    </div>
    <div class="card">
      <h3 id="totalExpenses">â‚±0</h3>
      <p>Expenses Today</p>
    </div>
    <div class="card">
      <h3 id="netProfit">â‚±0</h3>
      <p>Net Profit</p>
    </div>
    <div class="card">
      <h3 id="totalItems">0</h3>
      <p>Total Products</p>
    </div>
  </div>

  <div class="section">
    <h3>ðŸ›’ Sell Product</h3>
    <select id="sell_product" onchange="autoFillPrice()">
      <option value="">Select Product</option>
    </select>
    <input id="sell_unit" disabled placeholder="Unit" />
    <input id="sell_price" type="number" placeholder="Price per Unit" />
    <input id="sell_qty" type="number" placeholder="Quantity" min="1" value="1" />
    <button id="add-to-cart-btn" onclick="addToCart()">Add to Cart</button>

    <hr style="margin: 20px 0; border: none; border-top: 1px dashed #ccc;">

    <h3>ðŸ›’ Current Cart</h3>
    <div id="cartContent">
      <p>No items in cart.</p>
    </div>
    <div class="total-due">
      Total Due: <span id="cartTotal">â‚±0</span>
    </div>
    <div class="button-group">
      <button id="complete-sale-btn" onclick="completeSale()" disabled>Complete Sale</button>
      <button class="clear-cart-btn" onclick="clearCart()" disabled>Clear Cart</button>
    </div>

    <div class="receipt" id="receipt">
      <div class="store-name">LLAVORE VARIETY STORE</div>
      <h4>ðŸ§¾ Receipt</h4>
      <div id="receiptContent"></div>
      <button onclick="printReceipt()">ðŸ–¨ Print Receipt</button>
    </div>
  </div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbwFQyOrtTf694cH6wjTEJ067591IbUxqk3kN5clDWdtgC-fypBa9KdvxU6EcNbRHPQ/exec"; // IMPORTANT: Replace with your actual deployed script URL
    const SALES_SHEET_URL = "https://docs.google.com/spreadsheets/d/1omEc8zI_eHq3jxPvR8K5KsLjqYcRgNd16FjedOtzvng/gviz/tq?tqx=out:csv&sheet=SalesData";
    const EXPENSES_SHEET_URL = "https://docs.google.com/spreadsheets/d/1omEc8zI_eHq3jxPvR8K5KsLjqYcRgNd16FjedOtzvng/gviz/tq?tqx=out:csv&sheet=Expenses";

    let inventoryData = [];
    let currentTransactionItems = [];

    // --- Utility Functions ---
    function formatCurrency(amount) {
      return `â‚±${parseFloat(amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function todayYYYYMMDD() {
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }

    // --- Inventory and Dashboard Functions ---
    async function fetchInventory() {
      try {
        const res = await fetch(SHEET_URL + "?action=getInventory");
        const data = await res.json();
        inventoryData = data.slice(1); // skip header
        updateDropdown();
        document.getElementById("totalItems").textContent = inventoryData.length;
      } catch (error) {
        console.error("Error fetching inventory:", error);
        alert("Failed to load inventory data. Please check your internet connection and script deployment.");
      }
    }

    function updateDropdown() {
      const select = document.getElementById("sell_product");
      select.innerHTML = '<option value="">Select Product</option>';
      inventoryData.forEach(row => {
        const [product, qty] = row;
        select.innerHTML += `<option value="${product}">${product} (Stock: ${qty})</option>`;
      });
    }

    function autoFillPrice() {
      const selected = document.getElementById("sell_product").value;
      const product = inventoryData.find(row => row[0] === selected);
      if (product) {
        document.getElementById("sell_price").value = product[4]; // Assuming price is at index 4
        document.getElementById("sell_unit").value = product[2]; // Assuming unit is at index 2
        document.getElementById("sell_qty").max = product[1]; // Set max quantity to current stock
      } else {
        document.getElementById("sell_price").value = "";
        document.getElementById("sell_unit").value = "";
        document.getElementById("sell_qty").max = "";
      }
    }

    async function loadDashboard() {
      const today = todayYYYYMMDD();
      let totalSales = 0;
      let totalExpenses = 0;

      // Fetch Sales Data
      try {
        const salesRes = await fetch(SALES_SHEET_URL);
        if (!salesRes.ok) throw new Error(`HTTP error! status: ${salesRes.status}`);
        const salesText = await salesRes.text();
        salesText.split("\n").slice(1).forEach(row => {
          const cols = row.split(",");
          if (cols[0]) { // Ensure the date column is not empty
            const saleDate = cols[0].trim().split(' ')[0]; // Extract YYYY-MM-DD from "YYYY-MM-DD HH:MM:SS"
            if (saleDate === today) {
              totalSales += parseFloat(cols[5] || 0); // Assuming total is at index 5
            }
          }
        });
      } catch (error) {
        console.error("Failed to fetch sales data:", error);
        // alert("Could not load sales data for dashboard."); // Optional: alert user
      }

      // Fetch Expenses Data
      try {
        const expensesRes = await fetch(EXPENSES_SHEET_URL);
        if (!expensesRes.ok) throw new Error(`HTTP error! status: ${expensesRes.status}`);
        const expText = await expensesRes.text();
        expText.split("\n").slice(1).forEach(row => {
          const cols = row.split(",");
          if (cols[0]) { // Ensure the date column is not empty
            const expenseDate = cols[0].trim().split(' ')[0]; // Extract YYYY-MM-DD
            if (expenseDate === today) {
              totalExpenses += parseFloat(cols[2] || 0); // Assuming amount is at index 2
            }
          }
        });
      } catch (error) {
        console.error("Failed to fetch expenses data:", error);
        // alert("Could not load expenses data for dashboard."); // Optional: alert user
      }

      document.getElementById("totalSales").textContent = formatCurrency(totalSales);
      document.getElementById("totalExpenses").textContent = formatCurrency(totalExpenses);
      document.getElementById("netProfit").textContent = formatCurrency(totalSales - totalExpenses);
    }

    // --- Cart and Sale Functions ---
    function addToCart() {
      const product = document.getElementById("sell_product").value;
      const unit = document.getElementById("sell_unit").value;
      const quantity = parseInt(document.getElementById("sell_qty").value);
      const price = parseFloat(document.getElementById("sell_price").value);

      if (!product || isNaN(quantity) || isNaN(price) || quantity <= 0) {
        alert("Please select a product and enter valid quantity/price.");
        return;
      }

      const itemInInventory = inventoryData.find(row => row[0] === product);
      if (!itemInInventory) {
        alert("Selected product not found in inventory.");
        return;
      }

      const availableStock = parseInt(itemInInventory[1]);

      // Check if product already in cart, update quantity
      const existingCartItemIndex = currentTransactionItems.findIndex(item => item.product === product);
      if (existingCartItemIndex > -1) {
        const newQty = currentTransactionItems[existingCartItemIndex].quantity + quantity;
        if (newQty > availableStock) {
          alert(`Not enough stock for ${product}. Available: ${availableStock}`);
          return;
        }
        currentTransactionItems[existingCartItemIndex].quantity = newQty;
        currentTransactionItems[existingCartItemIndex].total = newQty * price;
      } else {
        if (quantity > availableStock) {
          alert(`Not enough stock for ${product}. Available: ${availableStock}`);
          return;
        }
        currentTransactionItems.push({ product, unit, quantity, price, total: quantity * price });
      }

      updateCartDisplay();
      document.getElementById("sell_product").value = "";
      document.getElementById("sell_unit").value = "";
      document.getElementById("sell_price").value = "";
      document.getElementById("sell_qty").value = "1";
      document.getElementById("sell_qty").max = ""; // Clear max value
    }

    function updateCartDisplay() {
      const cartContent = document.getElementById("cartContent");
      const cartTotalElement = document.getElementById("cartTotal");
      const completeSaleBtn = document.getElementById("complete-sale-btn");
      const clearCartBtn = document.getElementById("clear-cart-btn");

      if (currentTransactionItems.length === 0) {
        cartContent.innerHTML = '<p>No items in cart.</p>';
        cartTotalElement.textContent = formatCurrency(0);
        completeSaleBtn.disabled = true;
        clearCartBtn.disabled = true;
        return;
      }

      let totalDue = 0;
      cartContent.innerHTML = '';
      currentTransactionItems.forEach((item, index) => {
        totalDue += item.total;
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('cart-item');
        itemDiv.innerHTML = `
          <span>${item.product} x ${item.quantity} (${item.unit}) - ${formatCurrency(item.total)}</span>
          <button onclick="removeItemFromCart(${index})">Remove</button>
        `;
        cartContent.appendChild(itemDiv);
      });

      cartTotalElement.textContent = formatCurrency(totalDue);
      completeSaleBtn.disabled = false;
      clearCartBtn.disabled = false;
    }

    function removeItemFromCart(index) {
      currentTransactionItems.splice(index, 1);
      updateCartDisplay();
    }

    function clearCart() {
      currentTransactionItems = [];
      updateCartDisplay();
      document.getElementById("receipt").style.display = "none"; // Hide receipt if cart is cleared
    }

    async function completeSale() {
      if (currentTransactionItems.length === 0) {
        alert("Cart is empty. Please add products to sell.");
        return;
      }

      const receiptContentDiv = document.getElementById("receiptContent");
      receiptContentDiv.innerHTML = ''; // Clear previous receipt content
      let grandTotal = 0;

      // Build receipt content first
      currentTransactionItems.forEach(item => {
        receiptContentDiv.innerHTML += `
          <div class="receipt-item">
            <span>${item.product} x ${item.quantity} ${item.unit}</span>
            <span>${formatCurrency(item.total)}</span>
          </div>
        `;
        grandTotal += item.total;
      });

      receiptContentDiv.innerHTML += `
        <div class="receipt-total">
          <span>Grand Total:</span>
          <span>${formatCurrency(grandTotal)}</span>
        </div>
        <p style="text-align: center; margin-top: 15px; font-size: 0.8em;"><em>${new Date().toLocaleString()}</em></p>
      `;

      // Now send data to Google Sheet for each item
      let allSalesSuccessful = true;
      for (const item of currentTransactionItems) {
        const data = {
          action: "sell",
          product: item.product,
          unit: item.unit,
          quantity: item.quantity,
          price: item.price,
          total: item.total
        };

        const params = new URLSearchParams(data);
        try {
          // Use await to ensure each sale is processed sequentially for inventory updates
          const response = await fetch(SHEET_URL, { method: "POST", body: params });
          if (!response.ok) {
            console.error(`Error selling ${item.product}:`, response.statusText);
            allSalesSuccessful = false;
            // You might want to break here or alert the user about the specific item failure
          }
        } catch (error) {
          console.error("Network error selling product:", item.product, error);
          allSalesSuccessful = false;
          // alert(`Network error selling ${item.product}. Please check connection.`);
        }
      }

      if (allSalesSuccessful) {
        document.getElementById("receipt").style.display = "block";
        clearCart(); // Clear cart after successful sale
        await fetchInventory(); // Refresh stock
        await loadDashboard(); // Refresh report
      } else {
        alert("Some items failed to sell. Please check console for errors and retry specific items if needed.");
        // Do not clear cart if not all sales were successful, allow user to retry
      }
    }

    // --- Print Function for Receipt ---
    function printReceipt() {
        const receiptDiv = document.getElementById("receipt");
        // Create a temporary clone to remove the button, etc. for printing
        const receiptContentClone = receiptDiv.cloneNode(true);
        receiptContentClone.style.display = 'block'; // Ensure it's visible in the clone
        // Find and remove the print button from the clone
        const printButton = receiptContentClone.querySelector('button');
        if (printButton) {
            printButton.remove();
        }

        // Create a new window for printing
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>LLAVORE VARIETY STORE - Receipt</title>');

        // Copy essential styles for the receipt
        printWindow.document.write('<style>');
        printWindow.document.write(`
            body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; color: #333; }
            .receipt {
                background:#fff;
                padding:1.5rem;
                border:1px solid #eee;
                border-radius:8px;
                margin: 0 auto; /* Center the receipt if opened directly */
                width: 300px; /* Adjust width for receipt feel */
                max-width: 90%;
            }
            .receipt p { margin: 5px 0; line-height: 1.4; }
            .receipt-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px dashed #eee; }
            .receipt-total { font-weight: bold; margin-top: 10px; border-top: 2px solid #333; padding-top: 10px; }
            .store-name { text-align: center; font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; color: #009688; }
            /* Hide the print button itself on the printout, just in case */
            button { display: none !important; }
        `);
        printWindow.document.write('</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(receiptContentClone.outerHTML); // Use outerHTML to include the .receipt div itself
        printWindow.document.write('</body></html>');
        printWindow.document.close(); // Close the document opened by .write()

        // Wait for content to load, then print
        printWindow.onload = function() {
            printWindow.focus(); // Focus the new window
            printWindow.print(); // Trigger the print dialog
            // printWindow.close(); // Optional: Close the window after printing
        };
    }

    // --- Initial Load ---
    window.onload = async () => {
      await fetchInventory();
      await loadDashboard();
    };
  </script>

</body>
</html>
